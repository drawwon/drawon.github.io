<!doctype html>



  


<html class="theme-next mist use-motion" lang="default">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
    
  
  <link href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






  

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Spring," />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.0" />






<meta name="description" content="此教程跟随慕课网实战课程进行：https://coding.imooc.com/class/117.html">
<meta name="keywords" content="Spring">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring实战课程——微信点餐平台">
<meta property="og:url" content="http://drawwon.github.io/2018/09/25/Spring实战课程——微信点餐平台/index.html">
<meta property="og:site_name" content="WangZhao&#39;s Blog">
<meta property="og:description" content="此教程跟随慕课网实战课程进行：https://coding.imooc.com/class/117.html">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-25/97093913.jpg">
<meta property="og:image" content="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-26/53967472.jpg">
<meta property="og:image" content="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-26/91216516.jpg">
<meta property="og:image" content="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-26/54176380.jpg">
<meta property="og:image" content="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-10-7/21769142.jpg">
<meta property="og:updated_time" content="2019-03-30T08:51:06.343Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spring实战课程——微信点餐平台">
<meta name="twitter:description" content="此教程跟随慕课网实战课程进行：https://coding.imooc.com/class/117.html">
<meta name="twitter:image" content="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-25/97093913.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://drawwon.github.io/2018/09/25/Spring实战课程——微信点餐平台/"/>





  <title> Spring实战课程——微信点餐平台 | WangZhao's Blog </title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  














  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">WangZhao's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">It's not who you are underneath,it's what you do that defines you</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://drawwon.github.io/2018/09/25/Spring实战课程——微信点餐平台/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jeffrey Pacino">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WangZhao's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Spring实战课程——微信点餐平台
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-25T16:58:02+08:00">
                2018-09-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/网页/" itemprop="url" rel="index">
                    <span itemprop="name">网页</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>此教程跟随慕课网实战课程进行：<a href="https://coding.imooc.com/class/117.html" target="_blank" rel="noopener">https://coding.imooc.com/class/117.html</a></p>
<a id="more"></a>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>开发全程使用的ide是idea，数据库使用的是MySQL，开发系统用的是linux centos7.3，前端的技术栈是vue，但是本课程只注重后端部分，前端部分不涉及</p>
<h3 id="安装apache-maven"><a href="#安装apache-maven" class="headerlink" title="安装apache maven"></a>安装apache maven</h3><p>请访问Maven的下载页面：<a href="http://maven.apache.org/download.html" target="_blank" rel="noopener">http://maven.apache.org/download.html</a>，其中包含针对不同平台的各种版本的Maven下载文件。</p>
<p>解压apache-maven-3.5.4-bin.zip，并把解压后的文件夹下的apache-maven-3.5.4文件夹移动到<code>C:\Program Files</code> 下。</p>
<h4 id="添加环境变量"><a href="#添加环境变量" class="headerlink" title="添加环境变量"></a>添加环境变量</h4><p>右键“计算机”，选择“属性”，之后点击“高级系统设置”，点击“环境变量”，来设置环境变量，有以下系统变量需要配置：</p>
<p>新建系统变量   MAVEN_HOME  变量值：<code>C:\Program Files\apache-maven-3.5.4</code></p>
<p>编辑系统变量  Path         添加变量值： ;%MAVEN_HOME%\bin</p>
<h4 id="测试安装"><a href="#测试安装" class="headerlink" title="测试安装"></a>测试安装</h4><p>在cmd中使用<code>mvn --version</code>命令，成功打印出版本即安装成功</p>
<h4 id="换源"><a href="#换源" class="headerlink" title="换源"></a>换源</h4><p>国内访问maven源很慢，因此我们需要将maven源改为阿里镜像，使用<code>mvn -X</code>查找其中的mvn使用的settings文件，我们将默认的<code>settings.xml</code>文件拷贝至用户目录下的<code>.m2</code>文件夹，然后在镜像这一部分中加入：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>        </span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><p>通过idea创建项目，选择<code>new-&gt;project-&gt;Spring Initializr</code>修改好域名和项目名称之后，选择java版本，点击下一步，选择web和mysql/jdbc，如果没有选择jdbc这个内容，就要在<code>pom.xml</code>中配置jdbc</p>
<h2 id="数据库设计"><a href="#数据库设计" class="headerlink" title="数据库设计"></a>数据库设计</h2><p>数据库主要包含四个表：</p>
<ol>
<li>商品表</li>
<li>类目表</li>
<li>订单主表</li>
<li>订单详情表</li>
</ol>
<p>构建数据库的SQL语句如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `product_info` (</span><br><span class="line">    `product_id` VARCHAR(32) NOT NULL,</span><br><span class="line">    `product_name` VARCHAR(64) NOT NULL COMMENT &apos;商品名称&apos;,</span><br><span class="line">    `product_price` DECIMAL(8 , 2 ) NOT NULL COMMENT &apos;单价&apos;,</span><br><span class="line">    `product_stock` INT NOT NULL COMMENT &apos;库存&apos;,</span><br><span class="line">    `product_description` VARCHAR(64) COMMENT &apos;描述&apos;,</span><br><span class="line">    `product_icon` VARCHAR(512) COMMENT &apos;小图&apos;,</span><br><span class="line">    `product_status` TINYINT(3) COMMENT &apos;商品状态，0正常，1下架&apos;,</span><br><span class="line">    `category_type` INT NOT NULL COMMENT &apos;类目编号&apos;,</span><br><span class="line">    `create_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &apos;创建时间&apos;,</span><br><span class="line">    `update_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &apos;更新时间&apos;,</span><br><span class="line">    PRIMARY KEY (`product_id`)</span><br><span class="line">)  COMMENT &apos;商品表&apos;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE `product_category` (</span><br><span class="line">    `category_id` INT NOT NULL AUTO_INCREMENT,</span><br><span class="line">    `category_name` VARCHAR(64) NOT NULL COMMENT &apos;类目名称&apos;,</span><br><span class="line">    `category_type` INT NOT NULL COMMENT &apos;类目编号&apos;,</span><br><span class="line">    `create_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &apos;创建时间&apos;,</span><br><span class="line">    `update_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &apos;更新时间&apos;,</span><br><span class="line">    PRIMARY KEY (`category_id`),</span><br><span class="line">    UNIQUE KEY `uqe_category_type` (`category_type`) COMMENT &apos;建立索引&apos;</span><br><span class="line">)  COMMENT &apos;类目表&apos;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE `order_master` (</span><br><span class="line">    `order_id` VARCHAR(32) NOT NULL COMMENT &apos;订单id&apos;,</span><br><span class="line">    `buyer_name` VARCHAR(32) NOT NULL COMMENT &apos;买家名字&apos;,</span><br><span class="line">    `buyer_phone` VARCHAR(32) NOT NULL COMMENT &apos;买家电话&apos;,</span><br><span class="line">    `buyer_address` VARCHAR(128) NOT NULL COMMENT &apos;买家地址&apos;,</span><br><span class="line">    `buyer_openid` VARCHAR(64) NOT NULL COMMENT &apos;买家微信openid&apos;,</span><br><span class="line">    `order_amount` DECIMAL(8 , 2 ) NOT NULL COMMENT &apos;订单总金额,8位整数，2位小数&apos;,</span><br><span class="line">    `order_status` TINYINT(3) NOT NULL DEFAULT 0 COMMENT &apos;订单状态，默认为0新下单&apos;,</span><br><span class="line">    `pay_status` TINYINT(3) NOT NULL DEFAULT 0 COMMENT &apos;支付状态，默认为0未支付&apos;,</span><br><span class="line">    `create_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &apos;创建时间&apos;,</span><br><span class="line">    `update_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &apos;更新时间&apos;,</span><br><span class="line">    PRIMARY KEY (`order_id`),</span><br><span class="line">    KEY `idx_buyer_openid` (`buyer_openid`)</span><br><span class="line">)  COMMENT &apos;订单主表&apos;;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `order_detail` (</span><br><span class="line">    `detail_id` VARCHAR(32) NOT NULL COMMENT &apos;详情id&apos;,</span><br><span class="line">    `order_id` VARCHAR(32) NOT NULL COMMENT &apos;订单id&apos;,</span><br><span class="line">    `product_id` VARCHAR(32) NOT NULL COMMENT &apos;商品id&apos;,</span><br><span class="line">    `product_name` VARCHAR(64) NOT NULL COMMENT &apos;商品名称&apos;,</span><br><span class="line">    `product_price` DECIMAL(8 , 2 ) NOT NULL COMMENT &apos;商品价格&apos;,</span><br><span class="line">    `product_quantity` INT NOT NULL COMMENT &apos;商品数量&apos;,</span><br><span class="line">    `product_icon` VARCHAR(512) COMMENT &apos;商品小图&apos;,</span><br><span class="line">    `create_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &apos;创建时间&apos;,</span><br><span class="line">    `update_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &apos;更新时间&apos;,</span><br><span class="line">    PRIMARY KEY (`detail_id`),</span><br><span class="line">    KEY `idx_order_id` (`order_id`)</span><br><span class="line">)  COMMENT &apos;订单详情表&apos;;</span><br></pre></td></tr></table></figure>
<p>然后通过Navicat建立数据库连接，并新建数据库，注意这里的编码要选择utf8mb4，这个编码可以存储诸如emoji表情之类的特殊符号，而传统的utf-8编码则不能</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-25/97093913.jpg" alt=""></p>
<p>建好之后通过Navicat运行上面的sql脚本，即可生成多个表</p>
<h2 id="日志框架"><a href="#日志框架" class="headerlink" title="日志框架"></a>日志框架</h2><p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-26/53967472.jpg" alt=""></p>
<p>JUL来自官方，但是很多问题，首先淘汰；jboss用得也不多，其次淘汰；log4j和logback是同一个作者，logback是log4j的升级版，logback更好用</p>
<p>log4j2性能很强，但是很多框架不支持，因此删掉</p>
<p>最后我们剩下的就是SLF4j（Simple Logging Facade for Java 简单的java日志外观），Logback</p>
<p>在测试文件夹中新建LoggerTest类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.sell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoggerTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(LoggerTest.class);<span class="comment">//写入当前类的类名</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        logger.debug(<span class="string">"debug.........."</span>);</span><br><span class="line">        logger.info(<span class="string">"info----"</span>);</span><br><span class="line">        logger.error(<span class="string">"error......."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行测试函数，可以看到info和error这两条信息，但是debug没有看到，这是因为sl4j默认打印info以上的级别的日志，用<code>ctrl+n</code>搜索类，找到sl4j里面的level类，发现有如下五个日志级别：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Level &#123;</span><br><span class="line">    ERROR(<span class="number">40</span>, <span class="string">"ERROR"</span>),</span><br><span class="line">    WARN(<span class="number">30</span>, <span class="string">"WARN"</span>),</span><br><span class="line">    INFO(<span class="number">20</span>, <span class="string">"INFO"</span>),</span><br><span class="line">    DEBUG(<span class="number">10</span>, <span class="string">"DEBUG"</span>),</span><br><span class="line">    TRACE(<span class="number">0</span>, <span class="string">"TRACE"</span>);</span><br></pre></td></tr></table></figure>
<p>值越大的级别越高</p>
<h4 id="另一种引用SLF4j的方法"><a href="#另一种引用SLF4j的方法" class="headerlink" title="另一种引用SLF4j的方法"></a>另一种引用SLF4j的方法</h4><p>在test类上面加入注解<code>@Slf4j</code>，这要求你的idea有<code>Lombok</code>插件，否则下面的log标记无法正常识别，这样就不用定义logger变量</p>
<p>引入Lombok的方法是在<code>pom.xml</code>中添加：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>添加好之后就可以通过下面的方法来引用SLF4j</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoggerTest</span> </span>&#123;</span><br><span class="line"><span class="comment">//    private final Logger logger = LoggerFactory.getLogger(LoggerTest.class);</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String name = <span class="string">"imooc"</span>;</span><br><span class="line">        String passwd = <span class="string">"1234"</span>;</span><br><span class="line">        log.debug(<span class="string">"debug.........."</span>);</span><br><span class="line">        log.info(<span class="string">"info----"</span>);</span><br><span class="line">        log.info(<span class="string">"name:&#123;&#125;,password:&#123;&#125;"</span>,name,passwd);</span><br><span class="line">        log.error(<span class="string">"error......."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="配置log文件"><a href="#配置log文件" class="headerlink" title="配置log文件"></a>配置log文件</h4><p>可以直接通过<code>application.yml</code>配置SLF4j</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line"><span class="attr">  path:</span> <span class="string">./log/tomcat</span> <span class="comment">#配置存放地址，存放地址和文件名有一个即可</span></span><br><span class="line"><span class="attr">  file:</span> <span class="string">./log/tomcat/sell.log</span> <span class="comment">#配置文件名</span></span><br><span class="line"><span class="attr">  level:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>
<p>或者是在resources目录下新建一个<code>logback-spring.xml</code>，写入如下配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"consoleLog"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">layout</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.PatternLayout"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span></span><br><span class="line">                %d - %msg%n</span><br><span class="line">            <span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"fileInfoLog"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--只存储info而过滤error，如果还是用ThresholdFilter，比error等级高的都会被输出出来，因此要用LevelFilter--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.filter.LevelFilter"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>ERROR<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span></span><br><span class="line">                %msg%n</span><br><span class="line">            <span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--文件存储策略--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--路径--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>./log/tomcat/sell/info.%d.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"fileErrorLog"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.filter.ThresholdFilter"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>ERROR<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span></span><br><span class="line">                %msg%n</span><br><span class="line">            <span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--文件存储策略--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--路径--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>./log/tomcat/sell/error.%d.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"info"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"consoleLog"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"fileInfoLog"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"fileErrorLog"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="买家端开发"><a href="#买家端开发" class="headerlink" title="买家端开发"></a>买家端开发</h2><p>首先建立一个dataObject包用于存才各个数据表类</p>
<p>在其中建立ProductCategory类，创建id，名称，编号三个属性，最上面<code>@entity</code>，然后设置好getter和setter方法，在id上面<code>@Id</code>,<code>@GeneratedValue</code>用于表示id和自增</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.sell.dataObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.GeneratedValue;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Id;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductCategory</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 类目id</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="keyword">private</span> Integer categoryId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*类目名称*/</span></span><br><span class="line">    <span class="keyword">private</span> String categoryName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*类目编号*/</span></span><br><span class="line">    <span class="keyword">private</span> String categoryType;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"ProductCategory&#123;"</span> +</span><br><span class="line">                <span class="string">"categoryId="</span> + categoryId +</span><br><span class="line">                <span class="string">", categoryName='"</span> + categoryName + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", categoryType='"</span> + categoryType + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getCategoryId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> categoryId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCategoryId</span><span class="params">(Integer categoryId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.categoryId = categoryId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCategoryName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> categoryName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCategoryName</span><span class="params">(String categoryName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.categoryName = categoryName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCategoryType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> categoryType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCategoryType</span><span class="params">(String categoryType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.categoryType = categoryType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然，如此多的getter和setter方法，可以通过<code>lombok</code>这个包来省去这一步，包括tostring方法也可以省略了，首先在pom.xml中加入dependency</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后在idea的插件中搜索lombok，安装之后重启idea</p>
<p>在productCategory里面加入一个<code>@Data</code>注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@DynamicUpdate</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductCategory</span> </span>&#123;</span><br><span class="line">    <span class="comment">//类目id</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>(strategy = GenerationType.IDENTITY)</span><br><span class="line">    <span class="keyword">private</span> Integer categoryId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*类目名称*/</span></span><br><span class="line">    <span class="keyword">private</span> String categoryName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*类目编号*/</span></span><br><span class="line">    <span class="keyword">private</span> String categoryType;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后建立一个repository包，用于建立查询，新建<code>ProductCategoryRepository.java</code>，其中的接口继承自<code>JpaRepository</code>，然后后面两个参数是<code>&lt;ProductCategory,Integer&gt;</code>，类名和id类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.sell.repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.imooc.sell.dataObject.ProductCategory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductCategoryRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">ProductCategory</span>,<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在测试一下<code>ProductCategoryRepository</code>，直接右键点击<code>ProductCategoryRepository</code>，选择goto-&gt;test，新建test</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.sell.repository;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductCategoryRepositoryTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductCategoryRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findoneTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Optional&lt;ProductCategory&gt; productCategory = repository.findById(<span class="number">1</span>);</span><br><span class="line">        System.out.println(productCategory.toString());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>点击findoneTest，点击run，此时报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java.lang.IllegalStateException: Failed to load ApplicationContext</span><br><span class="line">....</span><br><span class="line">Caused by: java.lang.ClassNotFoundException: javax.xml.bind.JAXBException</span><br></pre></td></tr></table></figure>
<p>这是因为缺少<code>javax.xml.bind.JAXBException</code>包，在pom.xml中引入</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.activation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>接下来在数据库中手动添加一条数据，就可以实现查询了</p>
<p>因为Spring Boot 2的getOne要求transaction（事务操作），所以要在<code>application.yml</code>中添加no_trans的配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Spring:</span></span><br><span class="line"><span class="string">.....</span></span><br><span class="line">	<span class="attr">jpa:</span></span><br><span class="line"><span class="attr">        show-sql:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        properties:</span></span><br><span class="line"><span class="attr">          hibernate:</span></span><br><span class="line"><span class="attr">            enable_lazy_load_no_trans:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>接下来实现一下增删改查</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductCategoryRepositoryTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductCategoryRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findoneTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Optional&lt;ProductCategory&gt; productCategory = repository.findById(<span class="number">1</span>);</span><br><span class="line">        System.out.println(productCategory.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ProductCategory productCategory = <span class="keyword">new</span> ProductCategory();</span><br><span class="line">        productCategory.setCategoryName(<span class="string">"最受欢迎的"</span>);</span><br><span class="line">        productCategory.setCategoryType(<span class="string">"3"</span>);</span><br><span class="line">        repository.save(productCategory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//        Optional&lt;ProductCategory&gt; productCategorys = repository.getOne(2);</span></span><br><span class="line"><span class="comment">//        ProductCategory productCategory = new ProductCategory();</span></span><br><span class="line"><span class="comment">//        if (productCategorys.isPresent())&#123;</span></span><br><span class="line"><span class="comment">//             productCategory = productCategorys.get();</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        productCategory.setCategoryName("最受人们欢迎的");</span></span><br><span class="line"><span class="comment">//        productCategory.setCategoryType("3");</span></span><br><span class="line"><span class="comment">//        repository.save(productCategory);</span></span><br><span class="line"></span><br><span class="line">        ProductCategory productCategory = repository.getOne(<span class="number">2</span>);</span><br><span class="line">        productCategory.setCategoryName(<span class="string">"最受人们欢迎的"</span>);</span><br><span class="line">        productCategory.setCategoryType(<span class="string">"3"</span>);</span><br><span class="line">        repository.save(productCategory);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findByCategoryIdInTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Integer&gt; list = Arrays.asList(<span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line">        List&lt;ProductCategory&gt; result = repository.findByCategoryIdIn(list);</span><br><span class="line">        System.out.println(result.toString());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样直接运行会报错，要在项目设置中更改</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jpa:</span></span><br><span class="line"><span class="attr">  show-sql:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  properties:</span></span><br><span class="line"><span class="attr">    hibernate:</span></span><br><span class="line"><span class="attr">      enable_lazy_load_no_trans:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>其中的<code>findByCategoryIdIn</code>方法是定义在<code>ProductCategoryRepository.java</code>中的自定义查找方法，其名字就表明了他的用途，按照规定也只能这样起名字，最后一个in表示sql语句中in的意思</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">List&lt;ProductCategory&gt; <span class="title">findByCategoryIdIn</span><span class="params">(List&lt;Integer&gt; categoryTypeList)</span></span>;</span><br></pre></td></tr></table></figure>
<h4 id="jpa起名规范"><a href="#jpa起名规范" class="headerlink" title="jpa起名规范"></a>jpa起名规范</h4><p>Repository接口中声明方法的规范</p>
<p>1、查询方法以 find | read | get 开头；</p>
<p>2、涉及条件查询时，条件的属性用条件关键字连接，要注意的是：条件属性以首字母大写</p>
<p>例如：定义一个 Entity 实体类 class User｛</p>
<p>private String firstName;</p>
<p>private String lastName; ｝</p>
<p>使用And条件连接时，应这样写： findByLastNameAndFirstName(String lastName,String firstName); 条件的属性名称与个数要与参数的位置与个数一一对应</p>
<p>3、直接在接口中定义查询方法，如果是符合规范的，可以不用写实现，目前支持的关键字写法如下：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-26/91216516.jpg" alt=""></p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-26/54176380.jpg" alt=""></p>
<h3 id="服务层"><a href="#服务层" class="headerlink" title="服务层"></a>服务层</h3><p>新建一个CategoryService.java接口，定义<code>findOne</code>,<code>findAll</code>,<code>findByCategoryIn</code>,<code>save</code>四个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CategoryService</span> </span>&#123;</span><br><span class="line">    <span class="function">ProductCategory <span class="title">findOne</span><span class="params">(Integer categoryId)</span></span>;</span><br><span class="line">    <span class="function">List&lt;ProductCategory&gt; <span class="title">findAll</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;ProductCategory&gt; <span class="title">findByCategoryIdIn</span><span class="params">(List&lt;Integer&gt; categoryTypeList)</span></span>;</span><br><span class="line">    <span class="function">ProductCategory <span class="title">save</span><span class="params">(ProductCategory productCategory)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后新建impl文件夹，在其中写<code>CategoryServiceImpl.java</code>，用于实现<code>CategoryService</code>接口，记得要<code>@Service</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CategoryServiceImpl</span> <span class="keyword">implements</span> <span class="title">CategoryService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductCategoryRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ProductCategory <span class="title">findOne</span><span class="params">(Integer categoryId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.getOne(categoryId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ProductCategory&gt; <span class="title">findAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.findAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ProductCategory&gt; <span class="title">findByCategoryIdIn</span><span class="params">(List&lt;Integer&gt; categoryTypeList)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.findByCategoryIdIn(categoryTypeList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ProductCategory <span class="title">save</span><span class="params">(ProductCategory productCategory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.save(productCategory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写完这一部分之后开始单元测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CategoryServiceImplTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CategoryServiceImpl categoryService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//如果getCategoryId不等于1则assert</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findOne</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ProductCategory productCategory = categoryService.findOne(<span class="number">1</span>);</span><br><span class="line">        Assert.assertEquals(Integer.valueOf(<span class="number">1</span>),productCategory.getCategoryId());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//如果查出来的productCategoryList的长度为0则assert</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;ProductCategory&gt; productCategoryList = categoryService.findAll();</span><br><span class="line">        Assert.assertNotEquals(<span class="number">0</span>,productCategoryList.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findByCategoryIdIn</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;ProductCategory&gt; productCategoryList = categoryService.findByCategoryIdIn(Arrays.asList(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>));</span><br><span class="line">        Assert.assertNotEquals(<span class="number">0</span>,productCategoryList.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ProductCategory productCategory = <span class="keyword">new</span> ProductCategory();</span><br><span class="line">        productCategory.setCategoryName(<span class="string">"男生专用"</span>);</span><br><span class="line">        productCategory.setCategoryType(<span class="string">"10"</span>);</span><br><span class="line">        ProductCategory result = categoryService.save(productCategory);</span><br><span class="line">        Assert.assertNotEquals(<span class="keyword">null</span>,result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="商品相关开发"><a href="#商品相关开发" class="headerlink" title="商品相关开发"></a>商品相关开发</h3><p>顺序和之前一样，还是<code>DAO-&gt;Service-&gt;Controller</code>的顺序</p>
<p>首先我们在dataObject中，定义数据对象entity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductInfo</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String productId;</span><br><span class="line">    <span class="comment">//名字</span></span><br><span class="line">    <span class="keyword">private</span> String productName;</span><br><span class="line">    <span class="comment">//单价</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal productPrice;</span><br><span class="line">    <span class="comment">//库存</span></span><br><span class="line">    <span class="keyword">private</span> Integer productStock;</span><br><span class="line">    <span class="comment">//描述</span></span><br><span class="line">    <span class="keyword">private</span> String productDescription;</span><br><span class="line">    <span class="comment">//小图</span></span><br><span class="line">    <span class="keyword">private</span> String productIcon;</span><br><span class="line">    <span class="comment">//状态,0正常,1下架</span></span><br><span class="line">    <span class="keyword">private</span> Integer productStatus;</span><br><span class="line">    <span class="comment">//类目编号</span></span><br><span class="line">    <span class="keyword">private</span> Integer categoryType;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在repository中定义，与<code>ProductInfo</code>对应的<code>ProductInfoRepository</code>接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductInfoRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">ProductInfo</span>,<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">List&lt;ProductInfo&gt; <span class="title">findByProductStatus</span><span class="params">(Integer productStatus)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此DAO相关的定义完成，开始测试相关函数功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductInfoRepositoryTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductInfoRepository repository;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getOneTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ProductInfo productInfo = repository.getOne(<span class="string">"123456"</span>);</span><br><span class="line">        assertEquals(<span class="string">"123456"</span>,productInfo.getProductId());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">changeTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ProductInfo productInfo = repository.getOne(<span class="string">"123456"</span>);</span><br><span class="line">        productInfo.setProductPrice(BigDecimal.valueOf(<span class="number">10.5</span>));</span><br><span class="line">        ProductInfo reult = repository.save(productInfo);</span><br><span class="line">        assertNotNull(reult);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ProductInfo productInfo = <span class="keyword">new</span> ProductInfo();</span><br><span class="line">        productInfo.setProductId(<span class="string">"123456"</span>);</span><br><span class="line">        productInfo.setProductName(<span class="string">"皮蛋粥"</span>);</span><br><span class="line">        productInfo.setProductPrice(<span class="keyword">new</span> BigDecimal(<span class="number">3.2</span>));</span><br><span class="line">        productInfo.setProductStock(<span class="number">100</span>);</span><br><span class="line">        productInfo.setProductDescription(<span class="string">"很好喝"</span>);</span><br><span class="line">        productInfo.setProductDescription(<span class="string">"abc.jpg"</span>);</span><br><span class="line">        productInfo.setProductStatus(<span class="number">0</span>);</span><br><span class="line">        productInfo.setCategoryType(<span class="number">1</span>);</span><br><span class="line">        ProductInfo result = repository.save(productInfo);</span><br><span class="line">        assertNotNull(result);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findByProductStatusTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;ProductInfo&gt; productInfoList = repository.findByProductStatus(<span class="number">0</span>);</span><br><span class="line">        assertNotEquals(<span class="number">0</span>,productInfoList.size());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试全部通过，证明上面开发的部分没有问题</p>
<p>接下来开始写Service层。</p>
<h4 id="DAO和Service层的关系"><a href="#DAO和Service层的关系" class="headerlink" title="DAO和Service层的关系"></a>DAO和Service层的关系</h4><blockquote>
<p>DAO和Service层的关系</p>
<ol>
<li><p>初学Spring的时候，大家可能在DAO和Service层的关系上有些不解，为什么看上去DAO层和Service层做的事情一模一样，如果是这样，那么我们只需要DAO层不就行了吗？这是因为一开始开发的模型比较简单，等到系统越来越复杂的时候，我们查出来的内容可能就不是直接呈现给controller层了，而是经过很多的处理才交给controller层，这个时候的Service层就必不可少了，甚至一些诸如邮件通知之类的功能也可以放在service层，这样可以使controller层变得简洁。</p>
</li>
<li><p>第二个原因是因为用Service层包裹DAO层之后，当有攻击者攻击系统的时候，他只能访问由service层提供的几个函数来访问数据，只能获取少部分数据，而无法对整个数据库进行操作，这从一定程度上保证了数据库的安全性。</p>
</li>
</ol>
</blockquote>
<p>在service文件夹中新建<code>ProductService</code>接口，定义如下几个函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductService</span> </span>&#123;</span><br><span class="line">    <span class="function">ProductInfo <span class="title">findOne</span><span class="params">(String productId)</span></span>;</span><br><span class="line">    <span class="comment">//分页查询</span></span><br><span class="line">    <span class="function">Page&lt;ProductInfo&gt; <span class="title">findAll</span><span class="params">(Pageable pageable)</span></span>;</span><br><span class="line">    <span class="comment">//查询所有已上架的商品</span></span><br><span class="line">    <span class="function">List&lt;ProductInfo&gt; <span class="title">findUpAll</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">ProductInfo <span class="title">save</span><span class="params">(ProductInfo productInfo)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加库存</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//减库存</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后再implement实现这个接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductServiceImpl</span> <span class="keyword">implements</span> <span class="title">ProductService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductInfoRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ProductInfo <span class="title">findOne</span><span class="params">(String productId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.getOne(productId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Page&lt;ProductInfo&gt; <span class="title">findAll</span><span class="params">(Pageable pageable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.findAll(pageable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ProductInfo&gt; <span class="title">findUpAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.findByProductStatus(ProductStatusEnum.UP.getCode());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ProductInfo <span class="title">save</span><span class="params">(ProductInfo productInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.save(productInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后新建<code>BuyerProductController.java</code>处理controller层，list这个页面，主要的业务逻辑是：</p>
<ol>
<li><p>查出所有上架的商品</p>
</li>
<li><p>查出所有上架商品的categoryType</p>
</li>
<li><p>数据拼装：最外层是code，msg，data</p>
<ul>
<li><p>新建一个ResultVO用于存放最外层对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultVO</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//错误码</span></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="comment">//提示信息</span></span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">    <span class="comment">//返回的具体内容</span></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>新建一个ProductVO用于存放类别</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@JsonAutoDetect</span>(fieldVisibility = JsonAutoDetect.Visibility.ANY, getterVisibility = JsonAutoDetect.Visibility.NONE, setterVisibility = JsonAutoDetect.Visibility.NONE)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductVO</span> </span>&#123;</span><br><span class="line">    <span class="meta">@JsonProperty</span>(<span class="string">"name"</span>)</span><br><span class="line">    <span class="keyword">private</span> String CategoryName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonProperty</span>(<span class="string">"type"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer CategoryType;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonProperty</span>(<span class="string">"foods"</span>)</span><br><span class="line">    <span class="keyword">private</span> List&lt;ProductInfoVO&gt; productInfoVOList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>新建一个ProductInfoVO用于存放每个商品的具体信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductInfoVO</span> </span>&#123;</span><br><span class="line">    <span class="meta">@JsonProperty</span>(<span class="string">"id"</span>)</span><br><span class="line">    <span class="keyword">private</span> String productId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonProperty</span>(<span class="string">"name"</span>)</span><br><span class="line">    <span class="keyword">private</span> String productName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonProperty</span>(<span class="string">"price"</span>)</span><br><span class="line">    <span class="keyword">private</span> BigDecimal productPrice;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonProperty</span>(<span class="string">"description"</span>)</span><br><span class="line">    <span class="keyword">private</span> String productDescription;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonProperty</span>(<span class="string">"icon"</span>)</span><br><span class="line">    <span class="keyword">private</span> String productIcon;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>遍历category，然后再遍历所有product，如果当前的product的categoryType与当前的category相同，通过<code>BeanUtils.copyProperties</code>拷贝整个对象到另外一个，然后加入到<code>productVOList</code>中，最后设置msg和code，并返回</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 买家商品</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/buyer/product"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BuyerProductController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductService productService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CategoryService categoryService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/list"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResultVO <span class="title">list</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1. 查询所有的上架商品</span></span><br><span class="line">        List&lt;ProductInfo&gt; productInfoList = productService.findUpAll();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 查询类目(一次性查询)</span></span><br><span class="line">        List&lt;Integer&gt; categoryTypeList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">//传统方法</span></span><br><span class="line">        <span class="keyword">for</span> (ProductInfo productInfo : productInfoList) &#123;</span><br><span class="line">            categoryTypeList.add(productInfo.getCategoryType());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//精简方法(java8, lambda)</span></span><br><span class="line"><span class="comment">//        List&lt;Integer&gt; categoryTypeList = productInfoList.stream()</span></span><br><span class="line"><span class="comment">//                .map(e -&gt; e.getCategoryType())</span></span><br><span class="line"><span class="comment">//                .collect(Collectors.toList());</span></span><br><span class="line">        List&lt;ProductCategory&gt; productCategoryList = categoryService.findByCategoryTypeIn(categoryTypeList);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 数据拼装</span></span><br><span class="line">        List&lt;ProductVO&gt; productVOList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (ProductCategory productCategory: productCategoryList) &#123;</span><br><span class="line">            ProductVO productVO = <span class="keyword">new</span> ProductVO();</span><br><span class="line">            productVO.setCategoryType(productCategory.getCategoryType());</span><br><span class="line">            productVO.setCategoryName(productCategory.getCategoryName());</span><br><span class="line"></span><br><span class="line">            List&lt;ProductInfoVO&gt; productInfoVOList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (ProductInfo productInfo: productInfoList) &#123;</span><br><span class="line">                <span class="keyword">if</span> (productInfo.getCategoryType().equals(productCategory.getCategoryType())) &#123;</span><br><span class="line">                    ProductInfoVO productInfoVO = <span class="keyword">new</span> ProductInfoVO();</span><br><span class="line">                    BeanUtils.copyProperties(productInfo, productInfoVO);</span><br><span class="line">                    productInfoVOList.add(productInfoVO);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            productVO.setProductInfoVOList(productInfoVOList);</span><br><span class="line">            productVOList.add(productVO);</span><br><span class="line">        &#125;</span><br><span class="line">        ResultVO resultVO = <span class="keyword">new</span> ResultVO();</span><br><span class="line">        resultVO.setCode(<span class="number">0</span>);</span><br><span class="line">        resultVO.setMsg(<span class="string">"成功"</span>);</span><br><span class="line">        resultVO.setData(productVOList);</span><br><span class="line">        <span class="keyword">return</span> resultVO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现最后几行有些重复，我们新建一个utils包，用于存放杂件，新建一个ResultVOUtil，新建static方法，以便在上面的return中直接调用<code>return ResultVOUtil.success(productVOList);</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultVOUtil</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResultVO <span class="title">success</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        ResultVO resultVO = <span class="keyword">new</span> ResultVO&lt;&gt;();</span><br><span class="line">        resultVO.setCode(<span class="number">0</span>);</span><br><span class="line">        resultVO.setMsg(<span class="string">"成功"</span>);</span><br><span class="line">        resultVO.setData(o);</span><br><span class="line">        <span class="keyword">return</span> resultVO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResultVO <span class="title">success</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ResultVO resultVO = <span class="keyword">new</span> ResultVO&lt;&gt;();</span><br><span class="line">        resultVO.setCode(<span class="number">0</span>);</span><br><span class="line">        resultVO.setMsg(<span class="string">"成功"</span>);</span><br><span class="line">        <span class="keyword">return</span> resultVO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResultVO <span class="title">error</span><span class="params">(Integer code,String msg)</span> </span>&#123;</span><br><span class="line">        ResultVO resultVO = <span class="keyword">new</span> ResultVO&lt;&gt;();</span><br><span class="line">        resultVO.setCode(code);</span><br><span class="line">        resultVO.setMsg(msg);</span><br><span class="line">        <span class="keyword">return</span> resultVO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="前后端联调"><a href="#前后端联调" class="headerlink" title="前后端联调"></a>前后端联调</h3><ol>
<li><p>安装node依赖包，运行vue项目<br>首先cd到文件目录，执行下面的指令安装依赖</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br></pre></td></tr></table></figure>
<p>然后执行<code>npm run dev</code>，即可运行前端项目</p>
</li>
<li><p>刷新前端项目，发现前端的list指向的地址的端口有问题，因此用vscode搜索相关的地址之后可以找到vue项目设置的list函数的地址，并更改为<code>http://127.0.0.1:8080/sell/buyer/product/list</code></p>
</li>
<li><p>更改之后重新运行项目，发现可以访问了，但是没有数据返回，此时只需要在list函数上加入一个跨域访问的注解<code>@CrossOrigin(&quot;*&quot;)</code>，即可正常访问。</p>
</li>
</ol>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-10-7/21769142.jpg" alt=""></p>
<h2 id="订单层开发"><a href="#订单层开发" class="headerlink" title="订单层开发"></a>订单层开发</h2><p>同样开发顺序是DAO-&gt;Service-&gt;Controller，具体一点，先是定义dataObject，然后定义repository，这两部分组成了DAO层</p>
<h3 id="订单DAO层开发"><a href="#订单DAO层开发" class="headerlink" title="订单DAO层开发"></a>订单DAO层开发</h3><h4 id="dataObject定义"><a href="#dataObject定义" class="headerlink" title="dataObject定义"></a>dataObject定义</h4><p>订单一共有两个表，一个是OrderDetail（详情表），一个是OrderMaster（主表），对照数据库，定义每一个字段</p>
<ol>
<li>首先定义OrderMaster表，<code>@DynamicUpdate</code>用于动态更新updateTime，</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@DynamicUpdate</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderMaster</span> </span>&#123;</span><br><span class="line">    <span class="comment">//订单ID</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String orderId;</span><br><span class="line">    <span class="comment">//买家姓名</span></span><br><span class="line">    <span class="keyword">private</span> String buyerName;</span><br><span class="line">    <span class="comment">//买家电话</span></span><br><span class="line">    <span class="keyword">private</span> String buyerPhone;</span><br><span class="line">    <span class="comment">//买家地址</span></span><br><span class="line">    <span class="keyword">private</span> String buyerAddress;</span><br><span class="line">    <span class="comment">//买家openid</span></span><br><span class="line">    <span class="keyword">private</span> String buyerOpenid;</span><br><span class="line">    <span class="comment">//订单总额</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal orderAmount;</span><br><span class="line">    <span class="comment">//订单状态，默认为新下单,0是新下单,1是已完成，2是已取消</span></span><br><span class="line">    <span class="keyword">private</span> Integer orderStatus = OrderStatusEnum.NEW.getCode();</span><br><span class="line">    <span class="comment">//支付状态，默认为0未支付</span></span><br><span class="line">    <span class="keyword">private</span> Integer payStatus = PayStatusEnum.WAIT.getCode();</span><br><span class="line">    <span class="comment">//创建时间</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="comment">//更新时间</span></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>定义OrderDetail表</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderDetail</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String detailId;</span><br><span class="line">    <span class="comment">//订单id</span></span><br><span class="line">    <span class="keyword">private</span> String orderId;</span><br><span class="line">    <span class="comment">//商品id</span></span><br><span class="line">    <span class="keyword">private</span> String productId;</span><br><span class="line">    <span class="comment">//商品价格</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal productPrice;</span><br><span class="line">    <span class="comment">//商品名称</span></span><br><span class="line">    <span class="keyword">private</span> String productName;</span><br><span class="line">    <span class="comment">//商品数量</span></span><br><span class="line">    <span class="keyword">private</span> Integer productQuantity;</span><br><span class="line">    <span class="comment">//商品图标</span></span><br><span class="line">    <span class="keyword">private</span> String productIcon;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中用到的状态表示，要用枚举来表示，不至于那么乱</p>
<p>首先是<code>OrderStatusEnum</code>列举订单状态</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> OrderStatusEnum &#123;</span><br><span class="line">    NEW(<span class="number">0</span>,<span class="string">"新订单"</span>),</span><br><span class="line">    FINISHED(<span class="number">1</span>,<span class="string">"完结"</span>),</span><br><span class="line">    CANCEL(<span class="number">2</span>,<span class="string">"已取消"</span>),</span><br><span class="line">    ;</span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line"></span><br><span class="line">    OrderStatusEnum(Integer code, String msg) &#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后是<code>PayStatusEnum</code>枚举支付状态</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span>  PayStatusEnum &#123;</span><br><span class="line">    WAIT(<span class="number">0</span>,<span class="string">"未支付"</span>),</span><br><span class="line">    SUCCESS(<span class="number">1</span>,<span class="string">"支付成功"</span>),;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line"></span><br><span class="line">    PayStatusEnum(Integer code, String msg) &#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="repository定义及测试"><a href="#repository定义及测试" class="headerlink" title="repository定义及测试"></a>repository定义及测试</h4><p>对应两个dataObject，定义两个repository</p>
<ol>
<li><code>OrderMasterRepository</code>用于操作OrderMaster表</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderMasterRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">OrderMaster</span>,<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//通过用户来查找订单主表</span></span><br><span class="line">    <span class="function">Page&lt;OrderMaster&gt; <span class="title">findByBuyerOpenid</span><span class="params">(String buyerOpenId, Pageable pageable)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><code>OrderDetailRepository</code>用于操作OrderDetail表</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderDetailRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">OrderDetail</span>,<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//通过OrderId来查找详情表</span></span><br><span class="line">    <span class="function">List&lt;OrderDetail&gt; <span class="title">findByOrderId</span><span class="params">(String orderId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此，两个repository完成，开始测试</p>
<ol>
<li><code>OrderMasterRepositoryTest</code>用于测试OrderMasterRepository</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderMasterRepositoryTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderMasterRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        OrderMaster orderMaster = <span class="keyword">new</span> OrderMaster();</span><br><span class="line">        orderMaster.setOrderId(<span class="string">"1234567"</span>);</span><br><span class="line">        orderMaster.setBuyerName(<span class="string">"师兄"</span>);</span><br><span class="line">        orderMaster.setBuyerPhone(<span class="string">"18888888888"</span>);</span><br><span class="line">        orderMaster.setBuyerAddress(<span class="string">"重庆市"</span>);</span><br><span class="line">        orderMaster.setBuyerOpenid(<span class="string">"110110"</span>);</span><br><span class="line">        orderMaster.setOrderAmount(<span class="keyword">new</span> BigDecimal(<span class="number">10</span>));</span><br><span class="line">        OrderMaster result = repository.save(orderMaster);</span><br><span class="line">        assertNotNull(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findByBuyerOpenid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        PageRequest pageRequest = PageRequest.of(<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">        Page&lt;OrderMaster&gt; result = repository.findByBuyerOpenid(<span class="string">"110110"</span>,pageRequest);</span><br><span class="line">        System.out.println(result.getTotalElements());</span><br><span class="line">        assertNotEquals(<span class="number">0</span>,result.getSize());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><code>OrderDetailRepositoryTest</code>用于测试OrderDetailRepository</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderDetailRepositoryTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderDetailRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        OrderDetail orderDetail = <span class="keyword">new</span> OrderDetail();</span><br><span class="line">        orderDetail.setDetailId(<span class="string">"11111100"</span>);</span><br><span class="line">        orderDetail.setOrderId(<span class="string">"12345678"</span>);</span><br><span class="line">        orderDetail.setProductIcon(<span class="string">"abc.jpg"</span>);</span><br><span class="line">        orderDetail.setProductId(<span class="string">"a111"</span>);</span><br><span class="line">        orderDetail.setProductName(<span class="string">"南瓜"</span>);</span><br><span class="line">        orderDetail.setProductPrice(<span class="keyword">new</span> BigDecimal(<span class="number">10.5</span>));</span><br><span class="line">        orderDetail.setProductQuantity(<span class="number">2</span>);</span><br><span class="line">        OrderDetail result = repository.save(orderDetail);</span><br><span class="line">        assertNotNull(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findByOrderId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;OrderDetail&gt; orderDetailList = repository.findByOrderId(<span class="string">"12345678"</span>);</span><br><span class="line">        assertNotEquals(<span class="number">0</span>,orderDetailList.size());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此，订单DAO层开发完成，接下来开发Service层</p>
<h3 id="订单Service层开发"><a href="#订单Service层开发" class="headerlink" title="订单Service层开发"></a>订单Service层开发</h3><p>创建一个名为<code>OrderService.java</code>的接口，包含以下6个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderService</span> </span>&#123;</span><br><span class="line">    <span class="comment">//创建订单</span></span><br><span class="line">    <span class="function">OrderDTO <span class="title">create</span><span class="params">(OrderDTO orderDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询单个订单</span></span><br><span class="line">    <span class="function">OrderDTO <span class="title">getOne</span><span class="params">(String orderId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询订单列表</span></span><br><span class="line">    <span class="function">Page&lt;OrderDTO&gt; <span class="title">findList</span><span class="params">(String buyerOpenid, Pageable pageable)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//取消订单</span></span><br><span class="line">    <span class="function">OrderDTO <span class="title">cancel</span><span class="params">(OrderDTO orderDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//完结订单</span></span><br><span class="line">    <span class="function">OrderDTO <span class="title">finish</span><span class="params">(OrderDTO orderDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//支付订单</span></span><br><span class="line">    <span class="function">OrderDTO <span class="title">paid</span><span class="params">(OrderDTO orderDTO)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建<code>ProductServiceImpl.java</code>实现上面的接口</p>
<p>其中需要用到一个Data Transform Object，名称为OrderDTO，其大部分字段与OrderMaster一样，多了一个<code>List&lt;OrderDetail&gt; orderDetailList</code>字段，用于保存每个订单对应的OrderDetail信息，定义如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//OrderDTO.java</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="comment">//@JsonSerialize(include = JsonSerialize.Inclusion.NON_NULL)</span></span><br><span class="line"><span class="meta">@JsonInclude</span>(JsonInclude.Include.NON_NULL)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderDTO</span> </span>&#123;</span><br><span class="line">    <span class="comment">//订单ID</span></span><br><span class="line">    <span class="keyword">private</span> String orderId;</span><br><span class="line">    <span class="comment">//买家姓名</span></span><br><span class="line">    <span class="keyword">private</span> String buyerName;</span><br><span class="line">    <span class="comment">//买家电话</span></span><br><span class="line">    <span class="keyword">private</span> String buyerPhone;</span><br><span class="line">    <span class="comment">//买家地址</span></span><br><span class="line">    <span class="keyword">private</span> String buyerAddress;</span><br><span class="line">    <span class="comment">//买家openid</span></span><br><span class="line">    <span class="keyword">private</span> String buyerOpenid;</span><br><span class="line">    <span class="comment">//订单总额</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal orderAmount;</span><br><span class="line">    <span class="comment">//订单状态，默认为新下单,0是新下单,1是已完成，2是已取消</span></span><br><span class="line">    <span class="keyword">private</span> Integer orderStatus = OrderStatusEnum.NEW.getCode();</span><br><span class="line">    <span class="comment">//支付状态，默认为0未支付</span></span><br><span class="line">    <span class="keyword">private</span> Integer payStatus = PayStatusEnum.WAIT.getCode();</span><br><span class="line">    <span class="comment">//创建时间</span></span><br><span class="line">    <span class="meta">@JsonSerialize</span>(using = Date2LongSerializer.class)</span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="comment">//更新时间</span></span><br><span class="line">    <span class="meta">@JsonSerialize</span>(using = Date2LongSerializer.class)</span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;OrderDetail&gt; orderDetailList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中需要用到的SellException定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SellException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SellException</span><span class="params">(ResultEnum resultEnum)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(resultEnum.getMessage());</span><br><span class="line">        <span class="keyword">this</span>.code = resultEnum.getCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SellException</span><span class="params">(Integer code, String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(msg);</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SellException引用的ResultEnum枚举，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ResultEnum &#123;</span><br><span class="line">    PARAM_ERROR(<span class="number">1</span>, <span class="string">"参数不正确"</span>),</span><br><span class="line">    PRODUCT_NOT_EXIST(<span class="number">10</span>, <span class="string">"商品不存在"</span>),</span><br><span class="line">    PRODUCT_STOCK_ERROR(<span class="number">11</span>, <span class="string">"库存不足"</span>),</span><br><span class="line">    ORDER_NOT_EXSIT(<span class="number">12</span>, <span class="string">"订单不存在"</span>),</span><br><span class="line">    ORDER_DETAIL_NOT_EXSIT(<span class="number">12</span>, <span class="string">"订单详情不存在"</span>),</span><br><span class="line">    ORDER_STATUS_ERROR(<span class="number">14</span>, <span class="string">"订单状态不正确"</span>),</span><br><span class="line">    ORDER_UPDATE_FAIL(<span class="number">15</span>, <span class="string">"订单更新失败"</span>),</span><br><span class="line">    ORDER_DETAIL_EMPTY(<span class="number">16</span>, <span class="string">"订单详情为空"</span>),</span><br><span class="line">    PAY_STAUS_ERROR(<span class="number">17</span>, <span class="string">"支付状态不正确"</span>),</span><br><span class="line">    CART_EMPTY(<span class="number">18</span>, <span class="string">"购物车为空"</span>),</span><br><span class="line">    ORDER_OWNER_ERROR(<span class="number">19</span>, <span class="string">"该订单不属于当前用户"</span>),;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    ResultEnum(Integer code, String message) &#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建订单"><a href="#创建订单" class="headerlink" title="创建订单"></a>创建订单</h4><p>create方法：传入一个orderDTO，查找商品，计算总价</p>
<p>传入的参数如下所示：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">name: "张三"</span><br><span class="line">phone: "18868822111"</span><br><span class="line">address: "慕课网总部"</span><br><span class="line">openid: "ew3euwhd7sjw9diwkq" //用户的微信openid</span><br><span class="line">items: [&#123;</span><br><span class="line">    productId: "1423113435324",</span><br><span class="line">    productQuantity: 2 //购买数量</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>
<p>因此，要通过productId来查询productInfo，然后获取价格乘以数量，得到总价，然后设置DTO的详细信息，设置OrderId和orderDetailId</p>
<p>设置ID的方法写在utils文件夹中，为了不重复，所以加上同步锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//utils/KeyUtil.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KeyUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成唯一主键</span></span><br><span class="line"><span class="comment">     * 格式：时间+随机数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> String <span class="title">genUniqueKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Random random = <span class="keyword">new</span> Random();</span><br><span class="line">        Integer number = random.nextInt(<span class="number">900000</span>) + <span class="number">100000</span>;</span><br><span class="line">        <span class="keyword">return</span> System.currentTimeMillis() + String.valueOf(number);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第三步是写入OrderMaster，拷贝OrderDTO到OrderMater对象中，设置总价，保存</p>
<p>第四步是扣库存，扣库存的函数是<code>productService.decreaseStock</code>，其中用到的数据转移对象是<code>CartDTO</code>，包含id和数量，定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CartDTO</span> </span>&#123;</span><br><span class="line">    <span class="comment">//商品id</span></span><br><span class="line">    <span class="keyword">private</span> String productId;</span><br><span class="line">    <span class="comment">//商品数量</span></span><br><span class="line">    <span class="keyword">private</span> Integer productQuantity;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CartDTO</span><span class="params">(String productId, Integer productQuantity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.productId = productId;</span><br><span class="line">        <span class="keyword">this</span>.productQuantity = productQuantity;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>扣库存的函数如下，通过id查出商品的库存，减去购物车里面的库存，保存商品信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decreaseStock</span><span class="params">(List&lt;CartDTO&gt; cartDTOList)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (CartDTO cartDTO : cartDTOList) &#123;</span><br><span class="line">        ProductInfo productInfo = repository.findById(cartDTO.getProductId()).orElse(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (productInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SellException(ResultEnum.PRODUCT_NOT_EXIST);</span><br><span class="line">        &#125;</span><br><span class="line">        Integer result = productInfo.getProductStock() - cartDTO.getProductQuantity();</span><br><span class="line">        <span class="keyword">if</span> (result &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SellException(ResultEnum.PRODUCT_STOCK_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        productInfo.setProductStock(result);</span><br><span class="line">        repository.save(productInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此，创建订单的开发结束，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title">OrderService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductService productService; </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderDetailRepository orderDetailRepository;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderMasterRepository orderMasterRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OrderDTO <span class="title">create</span><span class="params">(OrderDTO orderDTO)</span> </span>&#123;</span><br><span class="line">        BigDecimal orderAmount = <span class="keyword">new</span> BigDecimal(<span class="number">0</span>);</span><br><span class="line">        String orderId = KeyUtil.genUniqueKey();</span><br><span class="line">        <span class="comment">//1.查询商品（数量，价格）</span></span><br><span class="line">        <span class="keyword">for</span> (OrderDetail orderDetail : orderDTO.getOrderDetailList()) &#123;</span><br><span class="line">            ProductInfo productInfo = productService.findOne(orderDetail.getProductId());</span><br><span class="line">            <span class="keyword">if</span> (productInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SellException(ResultEnum.PRODUCT_NOT_EXIST);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//2.计算总价</span></span><br><span class="line">            orderAmount = productInfo.getProductPrice()</span><br><span class="line">                    .multiply(<span class="keyword">new</span> BigDecimal(orderDetail.getProductQuantity()))</span><br><span class="line">                    .add(orderAmount);</span><br><span class="line">            <span class="comment">//订单详情入库OrderDetail</span></span><br><span class="line">            BeanUtils.copyProperties(productInfo, orderDetail);</span><br><span class="line">            orderDetail.setDetailId(KeyUtil.genUniqueKey());</span><br><span class="line">            orderDetail.setOrderId(orderId);</span><br><span class="line">            orderDetailRepository.save(orderDetail);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.写入订单数据库orderMaster</span></span><br><span class="line">        OrderMaster orderMaster = <span class="keyword">new</span> OrderMaster();</span><br><span class="line">        orderDTO.setOrderId(orderId);</span><br><span class="line">        BeanUtils.copyProperties(orderDTO, orderMaster);</span><br><span class="line">        orderMaster.setOrderAmount(orderAmount);</span><br><span class="line">        orderMasterRepository.save(orderMaster);</span><br><span class="line">        <span class="comment">//4.扣库存</span></span><br><span class="line">        List&lt;CartDTO&gt; cartDTOList = orderDTO.getOrderDetailList().stream().map(e -&gt;</span><br><span class="line">                <span class="keyword">new</span> CartDTO(e.getProductId(), e.getProductQuantity())</span><br><span class="line">        ).collect(Collectors.toList());</span><br><span class="line">        productService.decreaseStock(cartDTOList);</span><br><span class="line">        <span class="keyword">return</span> orderDTO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OrderDTO <span class="title">finish</span><span class="params">(OrderDTO orderDTO)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//判断订单状态</span></span><br><span class="line">        <span class="keyword">if</span> (!orderDTO.getOrderStatus().equals(OrderStatusEnum.NEW.getCode())) &#123;</span><br><span class="line">            log.error(<span class="string">"[完结订单]订单状态不正确，orderId=&#123;&#125;,orderStatus=&#123;&#125;"</span>, orderDTO.getOrderId(), orderDTO.getOrderStatus());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SellException(ResultEnum.ORDER_STATUS_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//修改状态并保存</span></span><br><span class="line">        orderDTO.setOrderStatus(OrderStatusEnum.FINISHED.getCode());</span><br><span class="line">        OrderMaster orderMaster = <span class="keyword">new</span> OrderMaster();</span><br><span class="line">        BeanUtils.copyProperties(orderDTO, orderMaster);</span><br><span class="line">        OrderMaster result = orderMasterRepository.save(orderMaster);</span><br><span class="line">        <span class="keyword">return</span> orderDTO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OrderDTO <span class="title">paid</span><span class="params">(OrderDTO orderDTO)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//判断订单状态</span></span><br><span class="line">        <span class="keyword">if</span> (!orderDTO.getOrderStatus().equals(OrderStatusEnum.NEW.getCode())) &#123;</span><br><span class="line">            log.error(<span class="string">"[支付订单]订单状态不正确，orderId=&#123;&#125;,orderStatus=&#123;&#125;"</span>, orderDTO.getOrderId(), orderDTO.getOrderStatus());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SellException(ResultEnum.ORDER_STATUS_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断支付状态</span></span><br><span class="line">        <span class="keyword">if</span> (!orderDTO.getOrderStatus().equals(PayStatusEnum.WAIT.getCode())) &#123;</span><br><span class="line">            log.error(<span class="string">"[支付订单]支付状态不正确，orderId=&#123;&#125;,payStatus=&#123;&#125;"</span>, orderDTO.getOrderId(), orderDTO.getPayStatus());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SellException(ResultEnum.PAY_STAUS_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//修改支付状态</span></span><br><span class="line">        orderDTO.setPayStatus(PayStatusEnum.SUCCESS.getCode());</span><br><span class="line">        OrderMaster orderMaster = <span class="keyword">new</span> OrderMaster();</span><br><span class="line">        BeanUtils.copyProperties(orderDTO, orderMaster);</span><br><span class="line">        orderMasterRepository.save(orderMaster);</span><br><span class="line">        <span class="keyword">return</span> orderDTO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="通过订单id查询订单"><a href="#通过订单id查询订单" class="headerlink" title="通过订单id查询订单"></a>通过订单id查询订单</h4><p>查询订单相对容易，通过一个id查找到订单主表orderMaster信息，通过id查到所有订单详情表的orderDetail信息，返回一个orderDTO对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OrderDTO <span class="title">getOne</span><span class="params">(String orderId)</span> </span>&#123;</span><br><span class="line">        OrderMaster orderMaster = orderMasterRepository.findById(orderId).orElse(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (orderMaster == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SellException(ResultEnum.ORDER_NOT_EXSIT);</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;OrderDetail&gt; orderDetailList = orderDetailRepository.findByOrderId(orderId);</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(orderDetailList)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SellException(ResultEnum.ORDER_DETAIL_NOT_EXSIT);</span><br><span class="line">        &#125;</span><br><span class="line">        OrderDTO orderDTO = <span class="keyword">new</span> OrderDTO();</span><br><span class="line">        BeanUtils.copyProperties(orderMaster, orderDTO);</span><br><span class="line">        orderDTO.setOrderDetailList(orderDetailList);</span><br><span class="line">        <span class="keyword">return</span> orderDTO;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="通过用户id查询订单列表"><a href="#通过用户id查询订单列表" class="headerlink" title="通过用户id查询订单列表"></a>通过用户id查询订单列表</h4><p>通过用户的openid来查询订单，要求返回一个page对象，包含的是OrderDTO类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Page&lt;OrderDTO&gt; <span class="title">findList</span><span class="params">(String buyerOpenid, Pageable pageable)</span> </span>&#123;</span><br><span class="line">        Page&lt;OrderMaster&gt; orderMasterPage = orderMasterRepository.findByBuyerOpenid(buyerOpenid, pageable);</span><br><span class="line">        List&lt;OrderDTO&gt; orderDTOList = OrderMaster2OrderDTOConverter.convert(orderMasterPage.getContent());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PageImpl&lt;OrderDTO&gt;(orderDTOList, pageable, orderMasterPage.getTotalElements());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>其中的findByBuyerOpenid方法定义如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//repository/OrderMasterRepository.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderMasterRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">OrderMaster</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">Page&lt;OrderMaster&gt; <span class="title">findByBuyerOpenid</span><span class="params">(String buyerOpenId, Pageable pageable)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="取消订单"><a href="#取消订单" class="headerlink" title="取消订单"></a>取消订单</h4><ol>
<li><p>首先判断订单是不是新下单状态，不是则抛出异常</p>
</li>
<li><p>如果是新下单，修改订单为取消状态</p>
</li>
<li><p>返还库存：<br>增加库存的函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increaseStock</span><span class="params">(List&lt;CartDTO&gt; cartDTOList)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (CartDTO cartDTO : cartDTOList) &#123;</span><br><span class="line">        ProductInfo productInfo = repository.findById(cartDTO.getProductId()).orElse(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (productInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SellException(ResultEnum.PRODUCT_NOT_EXIST);</span><br><span class="line">        &#125;</span><br><span class="line">        Integer result = productInfo.getProductStock() + cartDTO.getProductQuantity();</span><br><span class="line">        productInfo.setProductStock(result);</span><br><span class="line">        repository.save(productInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果已支付，退款：因为现在支付相关的函数还没有完成，因此这部分先空着，用<code>//TODO</code>来表示，这样点击左下角的TODO按钮，即可快速浏览这部分内容</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OrderDTO <span class="title">cancel</span><span class="params">(OrderDTO orderDTO)</span> </span>&#123;</span><br><span class="line">        OrderMaster orderMaster = <span class="keyword">new</span> OrderMaster();</span><br><span class="line">        <span class="comment">//判断订单状态</span></span><br><span class="line">        <span class="keyword">if</span> (!orderDTO.getOrderStatus().equals(OrderStatusEnum.NEW.getCode())) &#123;</span><br><span class="line">            log.error(<span class="string">"[取消订单] 订单状态不正确，orderId=&#123;&#125;，orderStatus=&#123;&#125;"</span>,</span><br><span class="line">                    orderDTO.getOrderId(), orderDTO.getOrderStatus());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SellException(ResultEnum.ORDER_STATUS_ERROR);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//修改订单状态</span></span><br><span class="line">        orderDTO.setOrderStatus(OrderStatusEnum.CANCEL.getCode());</span><br><span class="line">        BeanUtils.copyProperties(orderDTO, orderMaster);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            OrderMaster updateResult = orderMasterRepository.save(orderMaster);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">"[取消订单] 更新失败，orderMaster=&#123;&#125;"</span>, orderMaster);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SellException(ResultEnum.ORDER_UPDATE_FAIL);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//返还库存</span></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(orderDTO.getOrderDetailList())) &#123;</span><br><span class="line">            log.error(<span class="string">"[取消订单] 订单中无商品，OrderDto=&#123;&#125;"</span>, orderDTO);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SellException(ResultEnum.ORDER_DETAIL_EMPTY);</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;CartDTO&gt; cartDTOList = orderDTO.getOrderDetailList().stream()</span><br><span class="line">                .map(e -&gt; <span class="keyword">new</span> CartDTO(e.getProductId(), e.getProductQuantity()))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        productService.increaseStock(cartDTOList);</span><br><span class="line">        <span class="comment">//如果已支付，退款</span></span><br><span class="line">        <span class="keyword">if</span> (orderDTO.getPayStatus().equals(PayStatusEnum.SUCCESS.getCode())) &#123;</span><br><span class="line">            <span class="comment">//TODO</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> orderDTO;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="完结订单"><a href="#完结订单" class="headerlink" title="完结订单"></a>完结订单</h4><p>与取消订单相似，首先判断订单状态，如果是新下单，可以修改为完结并保存，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> OrderDTO <span class="title">finish</span><span class="params">(OrderDTO orderDTO)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//判断订单状态</span></span><br><span class="line">    <span class="keyword">if</span> (!orderDTO.getOrderStatus().equals(OrderStatusEnum.NEW.getCode())) &#123;</span><br><span class="line">        log.error(<span class="string">"[完结订单]订单状态不正确，orderId=&#123;&#125;,orderStatus=&#123;&#125;"</span>, orderDTO.getOrderId(), orderDTO.getOrderStatus());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SellException(ResultEnum.ORDER_STATUS_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//修改状态并保存</span></span><br><span class="line">    orderDTO.setOrderStatus(OrderStatusEnum.FINISHED.getCode());</span><br><span class="line">    OrderMaster orderMaster = <span class="keyword">new</span> OrderMaster();</span><br><span class="line">    BeanUtils.copyProperties(orderDTO, orderMaster);</span><br><span class="line">    OrderMaster result = orderMasterRepository.save(orderMaster);</span><br><span class="line">    <span class="keyword">return</span> orderDTO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="退款"><a href="#退款" class="headerlink" title="退款"></a>退款</h4><p>首先判断订单状态，然后判断支付状态，最后修改支付状态</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OrderDTO <span class="title">paid</span><span class="params">(OrderDTO orderDTO)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//判断订单状态</span></span><br><span class="line">        <span class="keyword">if</span> (!orderDTO.getOrderStatus().equals(OrderStatusEnum.NEW.getCode())) &#123;</span><br><span class="line">            log.error(<span class="string">"[支付订单]订单状态不正确，orderId=&#123;&#125;,orderStatus=&#123;&#125;"</span>, orderDTO.getOrderId(), orderDTO.getOrderStatus());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SellException(ResultEnum.ORDER_STATUS_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断支付状态</span></span><br><span class="line">        <span class="keyword">if</span> (!orderDTO.getOrderStatus().equals(PayStatusEnum.WAIT.getCode())) &#123;</span><br><span class="line">            log.error(<span class="string">"[支付订单]支付状态不正确，orderId=&#123;&#125;,payStatus=&#123;&#125;"</span>, orderDTO.getOrderId(), orderDTO.getPayStatus());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SellException(ResultEnum.PAY_STAUS_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//修改支付状态</span></span><br><span class="line">        orderDTO.setPayStatus(PayStatusEnum.SUCCESS.getCode());</span><br><span class="line">        OrderMaster orderMaster = <span class="keyword">new</span> OrderMaster();</span><br><span class="line">        BeanUtils.copyProperties(orderDTO, orderMaster);</span><br><span class="line">        orderMasterRepository.save(orderMaster);</span><br><span class="line">        <span class="keyword">return</span> orderDTO;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="订单Service测试"><a href="#订单Service测试" class="headerlink" title="订单Service测试"></a>订单Service测试</h4><p>测试代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceImplTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String buyerOpenid = <span class="string">"110110"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String Order_Id = <span class="string">"12345678"</span>;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderServiceImpl orderService;</span><br><span class="line">	</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        OrderDTO orderDTO = <span class="keyword">new</span> OrderDTO();</span><br><span class="line">        orderDTO.setBuyerAddress(<span class="string">"慕课网"</span>);</span><br><span class="line">        orderDTO.setBuyerName(<span class="string">"拜考神"</span>);</span><br><span class="line">        orderDTO.setBuyerPhone(<span class="string">"18888888888"</span>);</span><br><span class="line">        orderDTO.setBuyerOpenid(buyerOpenid);</span><br><span class="line">        <span class="comment">//购物车</span></span><br><span class="line">        List&lt;OrderDetail&gt; orderDetailList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        OrderDetail o1 = <span class="keyword">new</span> OrderDetail();</span><br><span class="line">        o1.setProductId(<span class="string">"123456"</span>);</span><br><span class="line">        o1.setProductQuantity(<span class="number">2</span>);</span><br><span class="line">        orderDetailList.add(o1);</span><br><span class="line">        orderDTO.setOrderDetailList(orderDetailList);</span><br><span class="line">        OrderDTO orderDTO1 = orderService.create(orderDTO);</span><br><span class="line">        assertNotNull(orderDTO1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getOne</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        OrderDTO result = orderService.getOne(Order_Id);</span><br><span class="line">        log.info(<span class="string">"[查询单个订单] result=&#123;&#125;"</span>, result);</span><br><span class="line">        assertNotNull(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        PageRequest request = PageRequest.of(<span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">        Page&lt;OrderDTO&gt; orderDTOPage = orderService.findList(buyerOpenid, request);</span><br><span class="line">        log.info(<span class="string">"查询订单List的结果：result=&#123;&#125;"</span>, orderDTOPage.getContent());</span><br><span class="line">        assertNotEquals(<span class="number">0</span>, orderDTOPage.getTotalElements());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        OrderDTO result = orderService.getOne(<span class="string">"123456"</span>);</span><br><span class="line">        OrderDTO orderDTO = orderService.cancel(result);</span><br><span class="line">        assertEquals(OrderStatusEnum.CANCEL.getCode(), orderDTO.getOrderStatus());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        OrderDTO result = orderService.getOne(<span class="string">"123456"</span>);</span><br><span class="line">        OrderDTO orderDTO = orderService.finish(result);</span><br><span class="line">        assertEquals(OrderStatusEnum.FINISHED.getCode(), orderDTO.getOrderStatus());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">paid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        OrderDTO result = orderService.getOne(<span class="string">"123456"</span>);</span><br><span class="line">        OrderDTO orderDTO = orderService.paid(result);</span><br><span class="line">        assertEquals(PayStatusEnum.SUCCESS.getCode(), orderDTO.getPayStatus());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="订单Controller层开发"><a href="#订单Controller层开发" class="headerlink" title="订单Controller层开发"></a>订单Controller层开发</h3><p>开发一个create页面，参数是一个OrderForm，其定义如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderForm</span> </span>&#123;</span><br><span class="line">    <span class="meta">@NotEmpty</span>(message = <span class="string">"姓名必填"</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotEmpty</span>(message = <span class="string">"手机号必填"</span>)</span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotEmpty</span>(message = <span class="string">"地址必填"</span>)</span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotEmpty</span>(message = <span class="string">"微信openid必填"</span>)</span><br><span class="line">    <span class="keyword">private</span> String openid;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotEmpty</span>(message = <span class="string">"购物车不能为空"</span>)</span><br><span class="line">    <span class="keyword">private</span> String items;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要求验证这个form的内容不为空，在定义时加入注解<code>@NotEmpty</code>，参数之前加入注解<code>@Valid</code></p>
<p>过程中要求把OrderFrom转换为OrderDTO，在converter包中新建类<code>OrderForm2OrderDTO</code>，用google的Gson工具，将string转换为对象，在pom.xml中需要加入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.code.gson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>OrderForm2OrderDTO</code>定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderForm2OrderDTO</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> OrderDTO <span class="title">convert</span><span class="params">(OrderForm orderForm)</span> </span>&#123;</span><br><span class="line">        OrderDTO orderDTO = <span class="keyword">new</span> OrderDTO();</span><br><span class="line">        Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">        orderDTO.setBuyerName(orderForm.getName());</span><br><span class="line">        orderDTO.setBuyerPhone(orderForm.getPhone());</span><br><span class="line">        orderDTO.setBuyerAddress(orderForm.getAddress());</span><br><span class="line">        orderDTO.setBuyerOpenid(orderForm.getOpenid());</span><br><span class="line">        List&lt;OrderDetail&gt; orderDetailList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            orderDetailList = gson.fromJson(orderForm.getItems(), <span class="keyword">new</span> TypeToken&lt;List&lt;OrderDetail&gt;&gt;() &#123;</span><br><span class="line">            &#125;.getType());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">"[对象转换]错误，string=&#123;&#125;"</span>, orderForm.getItems());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SellException(ResultEnum.PARAM_ERROR.getCode(), e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        orderDTO.setOrderDetailList(orderDetailList);</span><br><span class="line">        <span class="keyword">return</span> orderDTO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查找订单的内容，需要判断用户id和订单是不是一样，我们将这部分代码放在BuyerService当中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BuyerServiceImpl</span> <span class="keyword">implements</span> <span class="title">BuyerService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OrderDTO <span class="title">findOrderOne</span><span class="params">(String openid, String orderid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> checkOrderOwner(orderid, openid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OrderDTO <span class="title">cancelOrder</span><span class="params">(String openid, String orderid)</span> </span>&#123;</span><br><span class="line">        OrderDTO orderDTO = checkOrderOwner(openid, orderid);</span><br><span class="line">        <span class="keyword">if</span> (orderDTO == <span class="keyword">null</span>) &#123;</span><br><span class="line">            log.error(<span class="string">"[取消订单]查不到该订单,orderid=&#123;&#125;"</span>, orderid);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SellException(ResultEnum.ORDER_NOT_EXSIT);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> orderService.cancel(orderDTO);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> OrderDTO <span class="title">checkOrderOwner</span><span class="params">(String openid, String orderid)</span> </span>&#123;</span><br><span class="line">        OrderDTO orderDTO = orderService.getOne(orderid);</span><br><span class="line">        <span class="keyword">if</span> (orderDTO == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断是不是自己的订单</span></span><br><span class="line">        <span class="keyword">if</span> (!orderDTO.getBuyerOpenid().equals(openid)) &#123;</span><br><span class="line">            log.error(<span class="string">"[查询订单]订单openid不一致，openid=&#123;&#125;,orderid=&#123;&#125;"</span>, openid, orderid);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SellException(ResultEnum.ORDER_OWNER_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> orderDTO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>controller的定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/buyer/order"</span>)</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BuyerOrderController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BuyerService buyerService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建订单</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/create"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResultVO <span class="title">create</span><span class="params">(@Valid OrderForm orderForm, BindingResult bindingResult)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bindingResult.hasErrors()) &#123;</span><br><span class="line">            log.error(<span class="string">"[创建订单]参数不正确，orderForm=&#123;&#125;"</span>, orderForm);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SellException(ResultEnum.PARAM_ERROR.getCode(), Objects.requireNonNull(bindingResult.getFieldError()).getDefaultMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        OrderDTO orderDTO = <span class="keyword">new</span> OrderDTO();</span><br><span class="line">        orderDTO = OrderForm2OrderDTO.convert(orderForm);</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(orderDTO.getOrderDetailList())) &#123;</span><br><span class="line">            log.error(<span class="string">"[创建订单]购物车不能为空"</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SellException(ResultEnum.CART_EMPTY);</span><br><span class="line">        &#125;</span><br><span class="line">        OrderDTO createReuslt = orderService.create(orderDTO);</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"orderId"</span>, createReuslt.getOrderId());</span><br><span class="line">        <span class="keyword">return</span> ResultVOUtil.success(map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//订单列表</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/list"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResultVO <span class="title">list</span><span class="params">(@RequestParam(<span class="string">"openid"</span>)</span> String openid,</span></span><br><span class="line"><span class="function">                         @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"page"</span>, defaultValue = <span class="string">"0"</span>)</span> Integer page,</span></span><br><span class="line"><span class="function">                         @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"size"</span>, defaultValue = <span class="string">"10"</span>)</span> Integer size) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(openid)) &#123;</span><br><span class="line">            log.error(<span class="string">"[查询订单列表]openid为空"</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SellException(ResultEnum.PARAM_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        PageRequest request = PageRequest.of(page, size);</span><br><span class="line">        Page&lt;OrderDTO&gt; orderDTOPage = orderService.findList(openid, request);</span><br><span class="line">        <span class="keyword">return</span> ResultVOUtil.success(orderDTOPage.getContent());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//取消订单</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/cancel"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResultVO <span class="title">cancel</span><span class="params">(@RequestParam(<span class="string">"openid"</span>)</span> String openid,</span></span><br><span class="line"><span class="function">                           @<span class="title">RequestParam</span><span class="params">(<span class="string">"orderid"</span>)</span> String orderid) </span>&#123;</span><br><span class="line">		<span class="comment">// TODO 不安全的做法需要改进</span></span><br><span class="line">		<span class="comment">// OrderDTO orderDTO = orderService.getOne(orderid);</span></span><br><span class="line">		<span class="comment">// orderService.cancel(orderDTO);</span></span><br><span class="line">        OrderDTO orderDTO = buyerService.findOrderOne(openid, orderid);</span><br><span class="line">        <span class="keyword">return</span> ResultVOUtil.success();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//订单详情</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/detail"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResultVO <span class="title">detail</span><span class="params">(@RequestParam(<span class="string">"openid"</span>)</span> String openid,</span></span><br><span class="line"><span class="function">                           @<span class="title">RequestParam</span><span class="params">(<span class="string">"orderid"</span>)</span> String orderid) </span>&#123;</span><br><span class="line"><span class="comment">//        //TODO 不安全的做法，需要改进</span></span><br><span class="line"><span class="comment">//        OrderDTO orderDTO = orderService.getOne(orderid);</span></span><br><span class="line"><span class="comment">//        return ResultVOUtil.success(orderDTO);</span></span><br><span class="line">        OrderDTO orderDTO = buyerService.findOrderOne(openid, orderid);</span><br><span class="line">        <span class="keyword">return</span> ResultVOUtil.success(orderDTO);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后面的内容主要是关于支付的，等开发有需要的时候再研究这部分。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Spring/" rel="tag"># Spring</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/09/25/在服务器部署Jupyter-Notebook/" rel="next" title="在服务器部署Jupyter Notebook">
                <i class="fa fa-chevron-left"></i> 在服务器部署Jupyter Notebook
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/09/27/java常用数据结构/" rel="prev" title="java常用数据结构">
                java常用数据结构 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_douban"></a>
  <a class="jiathis_button_renren"></a>
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_kaixin001"></a>
  <a class="jiathis_button_copy"></a>
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Jeffrey Pacino" />
          <p class="site-author-name" itemprop="name">Jeffrey Pacino</p>
           
              <p class="site-description motion-element" itemprop="description">Humble to the dust and then out of the flowers</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">93</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">44</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">60</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/drawwon" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://wpa.qq.com/msgrd?v=3&uin=847707695&site=qq&menu=yes" target="_blank" title="QQ">
                  
                    <i class="fa fa-fw fa-qq"></i>
                  
                  QQ
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:jeffrey.pacino@gmail.com" target="_blank" title="email">
                  
                    <i class="fa fa-fw fa-paper-plane"></i>
                  
                  email
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#环境搭建"><span class="nav-number">1.</span> <span class="nav-text">环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装apache-maven"><span class="nav-number">1.1.</span> <span class="nav-text">安装apache maven</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#添加环境变量"><span class="nav-number">1.1.1.</span> <span class="nav-text">添加环境变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试安装"><span class="nav-number">1.1.2.</span> <span class="nav-text">测试安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#换源"><span class="nav-number">1.1.3.</span> <span class="nav-text">换源</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建项目"><span class="nav-number">1.2.</span> <span class="nav-text">创建项目</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据库设计"><span class="nav-number">2.</span> <span class="nav-text">数据库设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#日志框架"><span class="nav-number">3.</span> <span class="nav-text">日志框架</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#另一种引用SLF4j的方法"><span class="nav-number">3.0.1.</span> <span class="nav-text">另一种引用SLF4j的方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置log文件"><span class="nav-number">3.0.2.</span> <span class="nav-text">配置log文件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#买家端开发"><span class="nav-number">4.</span> <span class="nav-text">买家端开发</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#jpa起名规范"><span class="nav-number">4.0.1.</span> <span class="nav-text">jpa起名规范</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务层"><span class="nav-number">4.1.</span> <span class="nav-text">服务层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#商品相关开发"><span class="nav-number">4.2.</span> <span class="nav-text">商品相关开发</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#DAO和Service层的关系"><span class="nav-number">4.2.1.</span> <span class="nav-text">DAO和Service层的关系</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#前后端联调"><span class="nav-number">4.3.</span> <span class="nav-text">前后端联调</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#订单层开发"><span class="nav-number">5.</span> <span class="nav-text">订单层开发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#订单DAO层开发"><span class="nav-number">5.1.</span> <span class="nav-text">订单DAO层开发</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#dataObject定义"><span class="nav-number">5.1.1.</span> <span class="nav-text">dataObject定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#repository定义及测试"><span class="nav-number">5.1.2.</span> <span class="nav-text">repository定义及测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#订单Service层开发"><span class="nav-number">5.2.</span> <span class="nav-text">订单Service层开发</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建订单"><span class="nav-number">5.2.1.</span> <span class="nav-text">创建订单</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通过订单id查询订单"><span class="nav-number">5.2.2.</span> <span class="nav-text">通过订单id查询订单</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通过用户id查询订单列表"><span class="nav-number">5.2.3.</span> <span class="nav-text">通过用户id查询订单列表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#取消订单"><span class="nav-number">5.2.4.</span> <span class="nav-text">取消订单</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#完结订单"><span class="nav-number">5.2.5.</span> <span class="nav-text">完结订单</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#退款"><span class="nav-number">5.2.6.</span> <span class="nav-text">退款</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#订单Service测试"><span class="nav-number">5.2.7.</span> <span class="nav-text">订单Service测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#订单Controller层开发"><span class="nav-number">5.3.</span> <span class="nav-text">订单Controller层开发</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jeffrey Pacino</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery.lazyload/1.9.3/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>





  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
  


  

</body>
</html>
